@using WebShop.Models
@model OrderProductList
@{
    ViewBag.Title = "CheckOut";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>CheckOut</h2>

@if (!Model.OrderProductModels.Any())
{
    <p>Basket is empty.</p>
}
else
{

    using (Html.BeginForm(new { id = "form" }))
    {
        <div class="form-horizontal">
            @Html.AntiForgeryToken()
            @Html.ValidationSummary(true, "", new {@class = "text-danger"})
            <div class="form-group">
                <table class="table table-responsive table-striped">
                    <tr>
                        <th>
                            Product Name
                        </th>
                        <th>
                            #
                        </th>
                        <th>
                            Subtotal
                        </th>
                    </tr>
                    @for (var i = 0; i < Model.OrderProductModels.Count(); ++i)
                    {
                        <tr>
                            <td>
                                @Html.HiddenFor(m => m.OrderProductModels[i].ProductId)
                                @Html.DisplayFor(m => m.OrderProductModels[i].Product.Name)
                            </td>
                            <td>
                                @Html.EditorFor(m => m.OrderProductModels[i].Amount, new {htmlAttributes = new {@class = "form-control"}})
                            </td>
                            <td>
                                @Html.DisplayFor(m => m.OrderProductModels[i].Total)
                            </td>
                        </tr>
                    }

                    <tr>
                        <td colspan="2">
                            Total:
                        </td>
                        <td>
                            @Html.DisplayFor(m => m.Total)
                        </td>
                    </tr>
                </table>
            </div>

            <div class="form-group">
                <div class="pull-right">
                    <input class="btn btn-danger" id="submit" value="Pay" type="submit">
                </div>
            </div>
        </div>
    }
}

@section Scripts {
    @Scripts.Render("~/bundles/webshop")
    <script type="text/javascript">
        (function ($, utils) {
            var done = false;
            $("#submit").click(function (e) {
                if (done) {
                    done = false; // reset flag
                    return; // let the event bubble away
                }
                e.preventDefault();
                utils.jsonPost("/Basket/ReadyToPay", null, function () {
                    done = true; // set flag
                    $(e.currentTarget).trigger("click");
                });               
            });

        })(jQuery, webShop.utils)
    </script>
}


